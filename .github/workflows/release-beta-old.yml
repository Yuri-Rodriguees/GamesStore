name: Beta Release OLD (Para Testes de Atualiza√ß√£o)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Vers√£o OLD (ex: 0.9.9)'
        required: true
        type: string
      base_version:
        description: 'Vers√£o base para calcular (ex: 1.0.0)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  upload-modules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Verify modules
      run: |
        for file in uxmod.py xcore.py datax.py; do
          if [ ! -f "$file" ]; then
            echo "ERRO: $file n√£o encontrado"
            exit 1
          fi
        done
        echo "‚úÖ M√≥dulos encontrados"
    
    - name: Upload modules
      uses: actions/upload-artifact@v4
      with:
        name: secure-modules-beta-old
        path: |
          uxmod.py
          xcore.py
          datax.py
        retention-days: 30
  
  # ============================================
  # BUILD RELEASE OLD (VERS√ÉO ANTIGA PARA TESTE)
  # ============================================
  build-release-old:
    runs-on: windows-latest
    needs: upload-modules
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download modules
      uses: actions/download-artifact@v4
      with:
        name: secure-modules-beta-old
        path: .
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 requests bs4 psutil python-dotenv curl-cffi keyboard pyperclip Cython setuptools
      shell: pwsh
    
    - name: Create config
      run: |
        echo # config.py > config.py
        echo. >> config.py
        echo SECRET_KEY = b"${{ secrets.SECRET_KEY }}" >> config.py
        echo API_URL = "${{ secrets.API_URL }}" >> config.py
        echo API_URL_SITE = "${{ secrets.API_URL_SITE }}" >> config.py
        echo AUTH_CODE = "${{ secrets.AUTH_CODE }}" >> config.py
      shell: cmd
    
    - name: Set OLD version
      run: |
        $oldVersion = "${{ github.event.inputs.version }}"
        if (-not $oldVersion) {
          # Se n√£o fornecido, calcular baseado na vers√£o base
          $baseVersion = "${{ github.event.inputs.base_version }}"
          if ($baseVersion) {
            $parts = $baseVersion.Split('.')
            $parts[2] = [int]$parts[2] - 1
            $oldVersion = $parts -join '.'
          } else {
            $oldVersion = "0.9.9"
          }
        }
        $versionContent = "__version__ = `"$oldVersion-beta-old`""
        [System.IO.File]::WriteAllText("version.py", $versionContent, [System.Text.Encoding]::UTF8)
        Write-Host "‚úÖ Vers√£o OLD definida: $oldVersion-beta-old"
        echo "OLD_VERSION=$oldVersion-beta-old" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Compile modules
      run: |
        python setup.py build_ext --inplace
        
        if (Test-Path "uxmod.cp311-win_amd64.pyd") { Copy-Item "uxmod.cp311-win_amd64.pyd" "uxmod.pyd" -Force }
        if (Test-Path "xcore.cp311-win_amd64.pyd") { Copy-Item "xcore.cp311-win_amd64.pyd" "xcore.pyd" -Force }
        if (Test-Path "datax.cp311-win_amd64.pyd") { Copy-Item "datax.cp311-win_amd64.pyd" "datax.pyd" -Force }
      shell: pwsh
    
    - name: Verify compiled modules
      run: |
        if (-not (Test-Path "uxmod.pyd")) { Write-Error "‚ùå uxmod.pyd n√£o encontrado"; exit 1 }
        if (-not (Test-Path "xcore.pyd")) { Write-Error "‚ùå xcore.pyd n√£o encontrado"; exit 1 }
        if (-not (Test-Path "datax.pyd")) { Write-Error "‚ùå datax.pyd n√£o encontrado"; exit 1 }
        Write-Host "‚úÖ Todos os m√≥dulos compilados encontrados"
      shell: pwsh
    
    - name: Verify required files
      run: |
        $requiredFiles = @(
          "config.py",
          "version.py",
          "updater.py",
          "rc.py",
          "main.py",
          "assets/Images/icon.ico"
        )
        
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            Write-Error "‚ùå Arquivo obrigat√≥rio n√£o encontrado: $file"
            exit 1
          }
          Write-Host "‚úÖ $file"
        }
      shell: pwsh
    
    - name: Build RELEASE OLD EXE (SEM CONSOLE)
      run: |
        pyinstaller --noconfirm --onefile --windowed `
          --icon "assets/Images/icon.ico" `
          --add-data "config;config/" `
          --add-data "config.py;." `
          --add-data "version.py;." `
          --add-data "updater.py;." `
          --add-data "rc.py;." `
          --add-data "uxmod.pyd;." `
          --add-data "xcore.pyd;." `
          --add-data "datax.pyd;." `
          --hidden-import "uxmod" `
          --hidden-import "uxmod.softwarerei" `
          --collect-all "keyboard" `
          --hidden-import "keyboard" `
          --hidden-import "pyperclip" `
          --hidden-import "PyQt5.QtCore" `
          --hidden-import "PyQt5.QtGui" `
          --hidden-import "PyQt5.QtWidgets" `
          --hidden-import "PyQt5.sip" `
          --hidden-import "PyQt5.QtPrintSupport" `
          --hidden-import "requests" `
          --hidden-import "bs4" `
          --hidden-import "psutil" `
          --hidden-import "dotenv" `
          --hidden-import "curl_cffi" `
          --hidden-import "urllib3" `
          --hidden-import "certifi" `
          --hidden-import "charset_normalizer" `
          --noupx `
          --name "GamesStore" main.py
      shell: pwsh
    
    - name: Verify RELEASE OLD EXE created
      run: |
        if (-not (Test-Path "dist/GamesStore.exe")) {
          Write-Error "‚ùå GamesStore.exe n√£o foi criado"
          exit 1
        }
        $fileInfo = Get-Item "dist/GamesStore.exe"
        Write-Host "‚úÖ RELEASE OLD EXE criado com sucesso"
        Write-Host "   Tamanho: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
      shell: pwsh
    
    - name: Create PRERELEASE OLD
      uses: softprops/action-gh-release@v2
      with:
        files: dist/GamesStore.exe
        prerelease: true
        draft: false
        tag_name: v${{ env.OLD_VERSION }}
        name: "üß™ Beta OLD ${{ env.OLD_VERSION }} (Para Testes)"
        body: |
          ## ‚ö†Ô∏è VERS√ÉO BETA OLD - APENAS PARA TESTES DE ATUALIZA√á√ÉO
          
          **Esta √© uma vers√£o ANTIGA criada especificamente para testar o processo de atualiza√ß√£o.**
          
          ### üìã Como usar para testar atualiza√ß√µes:
          
          1. **Baixe e instale esta vers√£o OLD** (v${{ env.OLD_VERSION }})
          2. Execute o aplicativo
          3. O aplicativo deve detectar automaticamente a vers√£o beta mais recente
          4. Teste o processo de atualiza√ß√£o completo
          
          ### ‚ö†Ô∏è IMPORTANTE:
          
          - ‚ùå Esta vers√£o N√ÉO aparece na verifica√ß√£o autom√°tica de atualiza√ß√µes normais
          - ‚úÖ Use apenas para testar o sistema de atualiza√ß√£o
          - ‚úÖ Ap√≥s instalar, o aplicativo deve detectar a vers√£o beta mais recente
          - ‚úÖ Teste o fluxo completo: download ‚Üí instala√ß√£o ‚Üí rein√≠cio
          
          ### üîç Verificar atualiza√ß√µes:
          
          Se o aplicativo n√£o detectar automaticamente, voc√™ pode:
          - Verificar manualmente atrav√©s do menu (se dispon√≠vel)
          - Ou aguardar a verifica√ß√£o autom√°tica (3 segundos ap√≥s iniciar)
          
          ### üõ†Ô∏è Informa√ß√µes T√©cnicas
          
          - **Vers√£o:** `${{ env.OLD_VERSION }}`
          - **Build:** `${{ github.sha }}`
          - **Python:** 3.11
          - **PyInstaller:** Latest
          - **Workflow:** #${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

