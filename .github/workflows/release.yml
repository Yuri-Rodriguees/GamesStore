name: Release Completo

on:
  push:
    tags:
      - 'v*.*.*'  # Apenas tags sem -beta
  workflow_dispatch:

permissions:
  contents: write

jobs:
  upload-modules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Verify modules
      run: |
        # Verificar se os m√≥dulos compilados (.pyd) est√£o presentes
        # O c√≥digo fonte (.py) N√ÉO deve estar presente (exceto main.py, setup.py, version.py)
        for mod in uxmod xcore datax updater ui_components utils; do
          if [ ! -f "$mod.pyd" ] && [ ! -f "$mod.so" ]; then
             # No Linux pode ser .so, mas estamos enviando do Windows (.pyd)
             # O checkout traz o que est√° no repo. Se subirmos .pyd, eles estar√£o aqui.
             # Mas espere, .pyd √© bin√°rio Windows. O runner ubuntu n√£o vai conseguir validar se √© um .so v√°lido, mas pode checar a exist√™ncia.
             if [ -f "$mod.pyd" ]; then
                echo "‚úÖ $mod.pyd encontrado"
             else
                echo "ERRO: $mod.pyd n√£o encontrado"
                exit 1
             fi
          fi
        done
        
        if [ ! -d "core" ]; then
          echo "ERRO: diret√≥rio core n√£o encontrado"
          exit 1
        fi
        echo "‚úÖ M√≥dulos e diret√≥rio core encontrados"
    
    - name: Upload modules
      uses: actions/upload-artifact@v4
      with:
        name: secure-modules
        path: |
          *.pyd
          main.py
          rc.py
          config.py
          version.py
          core/
        retention-days: 90
        
  # ============================================
  # BUILD DEBUG (COM CONSOLE PARA VER ERROS)
  # ============================================
  build-debug:
    runs-on: windows-latest
    needs: upload-modules
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download modules
      uses: actions/download-artifact@v4
      with:
        name: secure-modules
        path: .
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 requests bs4 psutil python-dotenv curl-cffi keyboard pyperclip Cython setuptools
      shell: pwsh
    
    - name: Create config
      run: |
        echo # config.py > config.py
        echo. >> config.py
        echo SECRET_KEY = b"${{ secrets.SECRET_KEY }}" >> config.py
        echo API_URL = "${{ secrets.API_URL }}" >> config.py
        echo API_URL_SITE = "${{ secrets.API_URL_SITE }}" >> config.py
        echo AUTH_CODE = "${{ secrets.AUTH_CODE }}" >> config.py
      shell: cmd
    
    - name: Verify compiled modules
      run: |
        $modules = @("uxmod", "xcore", "datax", "updater", "ui_components", "utils")
        foreach ($mod in $modules) {
            if (-not (Test-Path "$mod.pyd")) { Write-Error "‚ùå $mod.pyd n√£o encontrado"; exit 1 }
        }
        Write-Host "‚úÖ Todos os m√≥dulos compilados encontrados"
      shell: pwsh
    
    - name: Verify required files
      run: |
        $requiredFiles = @(
          "config.py",
          "version.py",
          "rc.py",
          "main.py",
          "assets/Images/icon.ico",
          "config/xinput1_4.dll"
        )
        
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            Write-Error "‚ùå Arquivo obrigat√≥rio n√£o encontrado: $file"
            exit 1
          }
          Write-Host "‚úÖ $file"
        }
      shell: pwsh
    
    - name: Build DEBUG EXE (COM CONSOLE)
      run: |
        pyinstaller --noconfirm --onefile `
          --console `
          --log-level=DEBUG `
          --icon "assets/Images/icon.ico" `
          --add-data "config;config/" `
          --add-data "assets/config;assets/config" `
          --add-data "config.py;." `
          --add-data "version.py;." `
          --add-data "rc.py;." `
          --add-data "uxmod.pyd;." `
          --add-data "xcore.pyd;." `
          --add-data "datax.pyd;." `
          --add-data "updater.pyd;." `
          --add-data "ui_components.pyd;." `
          --add-data "utils.pyd;." `
          --add-data "core;core/" `
          --collect-all "keyboard" `
          --hidden-import "keyboard" `
          --hidden-import "pyperclip" `
          --hidden-import "PyQt5.QtCore" `
          --hidden-import "PyQt5.QtGui" `
          --hidden-import "PyQt5.QtWidgets" `
          --hidden-import "PyQt5.sip" `
          --hidden-import "PyQt5.QtPrintSupport" `
          --hidden-import "requests" `
          --hidden-import "bs4" `
          --hidden-import "psutil" `
          --hidden-import "dotenv" `
          --hidden-import "curl_cffi" `
          --hidden-import "urllib3" `
          --hidden-import "certifi" `
          --hidden-import "charset_normalizer" `
          --name "GamesStore-Debug" main.py 2>&1 | Tee-Object -FilePath "build-debug.log"
      shell: pwsh
    
    - name: Verify DEBUG EXE created
      run: |
        if (-not (Test-Path "dist/GamesStore-Debug.exe")) {
          Write-Error "‚ùå GamesStore-Debug.exe n√£o foi criado"
          exit 1
        }
        $fileInfo = Get-Item "dist/GamesStore-Debug.exe"
        Write-Host "‚úÖ DEBUG EXE criado com sucesso"
        Write-Host "   Tamanho: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
      shell: pwsh
    
    - name: Upload DEBUG EXE as artifact
      uses: actions/upload-artifact@v4
      with:
        name: GamesStore-Debug-${{ github.ref_name }}
        path: dist/GamesStore-Debug.exe
        retention-days: 30
    
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Debug-Log-${{ github.ref_name }}
        path: build-debug.log
        retention-days: 30
  
  # ============================================
  # BUILD RELEASE (SEM CONSOLE - VERS√ÉO FINAL)
  # ============================================
  build-release:
    runs-on: windows-latest
    needs: upload-modules
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download modules
      uses: actions/download-artifact@v4
      with:
        name: secure-modules
        path: .
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 requests bs4 psutil python-dotenv curl-cffi keyboard pyperclip Cython setuptools
      shell: pwsh
    
    - name: Create config
      run: |
        echo # config.py > config.py
        echo. >> config.py
        echo SECRET_KEY = b"${{ secrets.SECRET_KEY }}" >> config.py
        echo API_URL = "${{ secrets.API_URL }}" >> config.py
        echo API_URL_SITE = "${{ secrets.API_URL_SITE }}" >> config.py
        echo AUTH_CODE = "${{ secrets.AUTH_CODE }}" >> config.py
      shell: cmd
    
    - name: Verify compiled modules
      run: |
        $modules = @("uxmod", "xcore", "datax", "updater", "ui_components", "utils")
        foreach ($mod in $modules) {
            if (-not (Test-Path "$mod.pyd")) { Write-Error "‚ùå $mod.pyd n√£o encontrado"; exit 1 }
        }
        Write-Host "‚úÖ Todos os m√≥dulos compilados encontrados"
      shell: pwsh
    
    - name: Verify required files
      run: |
        $requiredFiles = @(
          "config.py",
          "version.py",
          "rc.py",
          "main.py",
          "assets/Images/icon.ico",
          "config/xinput1_4.dll"
        )
        
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            Write-Error "‚ùå Arquivo obrigat√≥rio n√£o encontrado: $file"
            exit 1
          }
          Write-Host "‚úÖ $file"
        }
      shell: pwsh
    
    - name: Build RELEASE EXE (SEM CONSOLE)
      run: |
        pyinstaller --noconfirm --onefile --windowed `
          --icon "assets/Images/icon.ico" `
          --add-data "config;config/" `
          --add-data "assets/config;assets/config" `
          --add-data "config.py;." `
          --add-data "version.py;." `
          --add-data "rc.py;." `
          --add-data "uxmod.pyd;." `
          --add-data "xcore.pyd;." `
          --add-data "datax.pyd;." `
          --add-data "updater.pyd;." `
          --add-data "ui_components.pyd;." `
          --add-data "utils.pyd;." `
          --add-data "core;core/" `
          --collect-all "keyboard" `
          --hidden-import "keyboard" `
          --hidden-import "pyperclip" `
          --hidden-import "PyQt5.QtCore" `
          --hidden-import "PyQt5.QtGui" `
          --hidden-import "PyQt5.QtWidgets" `
          --hidden-import "PyQt5.sip" `
          --hidden-import "PyQt5.QtPrintSupport" `
          --hidden-import "requests" `
          --hidden-import "bs4" `
          --hidden-import "psutil" `
          --hidden-import "dotenv" `
          --hidden-import "curl_cffi" `
          --hidden-import "urllib3" `
          --hidden-import "certifi" `
          --hidden-import "charset_normalizer" `
          --name "GamesStore" main.py
      shell: pwsh
    
    - name: Verify RELEASE EXE created
      run: |
        if (-not (Test-Path "dist/GamesStore.exe")) {
          Write-Error "‚ùå GamesStore.exe n√£o foi criado"
          exit 1
        }
        $fileInfo = Get-Item "dist/GamesStore.exe"
        Write-Host "‚úÖ RELEASE EXE criado com sucesso"
        Write-Host "   Tamanho: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
      shell: pwsh
    
    - name: Create RELEASE
      uses: softprops/action-gh-release@v2
      with:
        files: dist/GamesStore.exe
        prerelease: false
        draft: false
        tag_name: ${{ github.ref_name }}
        name: "üéÆ GamesStore ${{ github.ref_name }}"
        body: |
          ## üéÆ GamesStore ${{ github.ref_name }}
          
          ‚úÖ Recomendada para todos os usu√°rios
          ‚úÖ Vers√£o final testada e aprovada
          
          ### üì¶ Downloads Dispon√≠veis
          
          **Vers√£o Release (sem console):**
          - Para uso normal (n√£o mostra console)
          - Download: `GamesStore.exe` (anexo abaixo)
          
          **Vers√£o Debug (com console):**
          - Para debugging (mostra todos os erros)
          - Download nos [Artifacts desta Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - Arquivo: `GamesStore-Debug-${{ github.ref_name }}`
          
          ### üîç Como reportar bugs
          
          Se encontrar problemas, use a vers√£o DEBUG para ver os erros:
          ```
          cd caminho\do\arquivo
          .\GamesStore-Debug.exe
          ```
          
          A vers√£o Release cria logs autom√°ticos na pasta `logs\` ao lado do execut√°vel.
          Procure por arquivos `log.txt` e envie o conte√∫do.
          
          ### üìù Changelog
          
          - ‚úÖ Refatora√ß√£o modular do c√≥digo (m√≥dulo core/)
          - ‚úÖ Corre√ß√µes no ManualInstallScreen
          - ‚úÖ QFileDialog funcionando corretamente
          - ‚úÖ Hidden imports completos do PyQt5
          - ‚úÖ Sistema de logging autom√°tico
          - ‚úÖ Vers√£o DEBUG com console completo
          - ‚úÖ Todas as depend√™ncias inclu√≠das
          
          ### üõ†Ô∏è Informa√ß√µes T√©cnicas
          
          - **Build:** `${{ github.sha }}`
          - **Tag:** `${{ github.ref_name }}`
          - **Python:** 3.11
          - **PyInstaller:** Latest
          - **Workflow:** #${{ github.run_number }}
          - **Commit:** ${{ github.event.head_commit.message }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
