name: Release Completo

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  upload-modules:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Verify modules
      run: |
        for file in uxmod.py xcore.py datax.py updater.py ui_components.py utils.py main.py rc.py; do
          if [ ! -f "$file" ]; then
            echo "ERRO: $file nÃ£o encontrado"
            exit 1
          fi
        done
        if [ ! -d "core" ]; then
          echo "ERRO: diretÃ³rio core nÃ£o encontrado"
          exit 1
        fi
        echo "âœ… MÃ³dulos e diretÃ³rio core encontrados"
    
    - name: Upload modules
      uses: actions/upload-artifact@v4
      with:
        name: source-modules
        path: |
          *.py
          core/
          assets/
        retention-days: 1

  build-debug:
    runs-on: windows-latest
    needs: upload-modules
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download modules
      uses: actions/download-artifact@v4
      with:
        name: source-modules
        path: .
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 requests bs4 psutil python-dotenv curl-cffi keyboard pyperclip Cython setuptools
      shell: pwsh
    
    - name: Create config
      run: |
        echo # config.py > config.py
        echo. >> config.py
        echo SECRET_KEY = b"${{ secrets.SECRET_KEY }}" >> config.py
        echo API_URL = "${{ secrets.API_URL }}" >> config.py
        echo API_URL_SITE = "${{ secrets.API_URL_SITE }}" >> config.py
        echo AUTH_CODE = "${{ secrets.AUTH_CODE }}" >> config.py
      shell: cmd
    
    - name: Compile modules
      run: |
        python setup.py build_ext --inplace
        
        # Copiar pyd gerados para nomes limpos se necessÃ¡rio (setup.py jÃ¡ deve gerar corretamente com inplace)
        # Mas vamos garantir
        Get-ChildItem -Filter "*.pyd" | ForEach-Object {
            Write-Host "Compilado: $($_.Name)"
        }
      shell: pwsh
    
    - name: Build DEBUG EXE
      run: |
        # PyInstaller vai pegar os .pyd automaticamente se estiverem na pasta e importados
        # Mas vamos forÃ§ar a inclusÃ£o dos .pyd principais
        
        pyinstaller --noconfirm --onefile `
          --console `
          --log-level=DEBUG `
          --icon "assets/Images/icon.ico" `
          --add-data "config;config/" `
          --add-data "assets/config;assets/config" `
          --add-data "config.py;." `
          --add-data "version.py;." `
          --add-data "rc.py;." `
          --add-data "core;core/" `
          --collect-all "keyboard" `
          --hidden-import "keyboard" `
          --hidden-import "pyperclip" `
          --hidden-import "PyQt5.QtCore" `
          --hidden-import "PyQt5.QtGui" `
          --hidden-import "PyQt5.QtWidgets" `
          --hidden-import "PyQt5.sip" `
          --hidden-import "PyQt5.QtPrintSupport" `
          --hidden-import "requests" `
          --hidden-import "bs4" `
          --hidden-import "psutil" `
          --hidden-import "dotenv" `
          --hidden-import "curl_cffi" `
          --hidden-import "urllib3" `
          --hidden-import "certifi" `
          --hidden-import "charset_normalizer" `
          --name "GamesStore-Debug" main.py 2>&1 | Tee-Object -FilePath "build-debug.log"
      shell: pwsh
      
    - name: Upload DEBUG EXE
      uses: actions/upload-artifact@v4
      with:
        name: GamesStore-Debug-${{ github.ref_name }}
        path: dist/GamesStore-Debug.exe

  build-release:
    runs-on: windows-latest
    needs: upload-modules
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download modules
      uses: actions/download-artifact@v4
      with:
        name: source-modules
        path: .
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 requests bs4 psutil python-dotenv curl-cffi keyboard pyperclip Cython setuptools
      shell: pwsh
    
    - name: Create config
      run: |
        echo # config.py > config.py
        echo. >> config.py
        echo SECRET_KEY = b"${{ secrets.SECRET_KEY }}" >> config.py
        echo API_URL = "${{ secrets.API_URL }}" >> config.py
        echo API_URL_SITE = "${{ secrets.API_URL_SITE }}" >> config.py
        echo AUTH_CODE = "${{ secrets.AUTH_CODE }}" >> config.py
      shell: cmd
    
    - name: Compile modules
      run: |
        python setup.py build_ext --inplace
      shell: pwsh
    
    - name: Build RELEASE EXE
      run: |
        pyinstaller --noconfirm --onefile --windowed `
          --icon "assets/Images/icon.ico" `
          --add-data "config;config/" `
          --add-data "assets/config;assets/config" `
          --add-data "config.py;." `
          --add-data "version.py;." `
          --add-data "rc.py;." `
          --add-data "core;core/" `
          --collect-all "keyboard" `
          --hidden-import "keyboard" `
          --hidden-import "pyperclip" `
          --hidden-import "PyQt5.QtCore" `
          --hidden-import "PyQt5.QtGui" `
          --hidden-import "PyQt5.QtWidgets" `
          --hidden-import "PyQt5.sip" `
          --hidden-import "PyQt5.QtPrintSupport" `
          --hidden-import "requests" `
          --hidden-import "bs4" `
          --hidden-import "psutil" `
          --hidden-import "dotenv" `
          --hidden-import "curl_cffi" `
          --hidden-import "urllib3" `
          --hidden-import "certifi" `
          --hidden-import "charset_normalizer" `
          --name "GamesStore" main.py
      shell: pwsh
    
    - name: Create RELEASE
      uses: softprops/action-gh-release@v2
      with:
        files: dist/GamesStore.exe
        prerelease: false
        tag_name: ${{ github.ref_name }}
        name: "ðŸŽ® GamesStore ${{ github.ref_name }}"
        body: |
          ## ðŸŽ® GamesStore ${{ github.ref_name }}
          VersÃ£o oficial.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-repository:
    needs: [build-release]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Remove sensitive files
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "Removendo arquivos sensÃ­veis..."
          # Lista de arquivos para remover
          FILES_TO_REMOVE="uxmod.py xcore.py utils.py updater.py ui_components.py core assets/config backup venv logs release.ps1 secure_release.ps1 release-beta.ps1 setup.py config.py"
          
          for file in $FILES_TO_REMOVE; do
            if [ -e "$file" ]; then
              git rm -rf "$file" || echo "Falha ao remover $file"
            fi
          done
          
          # Commit e Push
          if git diff --staged --quiet; then
            echo "Nada para limpar."
          else
            git commit -m "Security Cleanup: Removing source files after release build"
            git push
            echo "Limpeza concluÃ­da."
          fi