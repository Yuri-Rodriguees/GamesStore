name: Release Completo

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  # ============================================
  # JOB 1: UPLOAD DOS 3 ARQUIVOS
  # ============================================
  upload-modules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Get branch name from tag
      id: get_branch
      run: |
        BRANCH=$(git ls-remote --symref origin HEAD | awk '/^ref:/ {sub(/refs\/heads\//, "", $2); print $2}')
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "Branch detectada: $BRANCH"
    
    - name: Verify modules exist
      id: check_modules
      run: |
        MISSING=""
        
        if [ ! -f "uxmod.py" ]; then
          echo "ERRO: uxmod.py nao encontrado"
          MISSING="$MISSING uxmod.py"
        fi
        
        if [ ! -f "xcore.py" ]; then
          echo "ERRO: xcore.py nao encontrado"
          MISSING="$MISSING xcore.py"
        fi
        
        if [ ! -f "datax.py" ]; then
          echo "ERRO: datax.py nao encontrado"
          MISSING="$MISSING datax.py"
        fi
        
        if [ -n "$MISSING" ]; then
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "missing=$MISSING" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "OK Todos os modulos encontrados"
          ls -lh uxmod.py xcore.py datax.py
        fi
    
    - name: Upload modules as artifacts
      if: steps.check_modules.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: secure-modules
        path: |
          uxmod.py
          xcore.py
          datax.py
        retention-days: 90
    
    - name: Configure Git
      if: steps.check_modules.outputs.exists == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Checkout branch
      if: steps.check_modules.outputs.exists == 'true'
      run: |
        git fetch origin ${{ steps.get_branch.outputs.branch }}
        git checkout ${{ steps.get_branch.outputs.branch }}
    
    - name: Remove modules from Git
      if: steps.check_modules.outputs.exists == 'true'
      run: |
        echo "Removendo modulos do Git..."
        
        git rm --cached uxmod.py xcore.py datax.py 2>/dev/null || true
        
        if git diff --cached --quiet; then
          echo "AVISO: Nenhum arquivo para remover"
        else
          git commit -m "chore: Remove modulos sensiveis apos upload [skip ci]"
          git push origin ${{ steps.get_branch.outputs.branch }}
          echo "OK Modulos removidos do repositorio"
        fi
  
  # ============================================
  # JOB 2: BUILD E RELEASE
  # ============================================
  build-release:
    runs-on: windows-latest
    needs: upload-modules
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download modules from artifacts
      uses: actions/download-artifact@v4
      with:
        name: secure-modules
        path: .
    
    - name: Verify modules downloaded
      run: |
        $missing = @()
        
        if (-not (Test-Path "uxmod.py")) { $missing += "uxmod.py" }
        if (-not (Test-Path "xcore.py")) { $missing += "xcore.py" }
        if (-not (Test-Path "datax.py")) { $missing += "datax.py" }
        
        if ($missing.Count -gt 0) {
          Write-Error "ERRO: Arquivos faltando: $($missing -join ', ')"
          exit 1
        }
        
        Write-Host "OK Todos os modulos baixados"
        Get-ChildItem uxmod.py, xcore.py, datax.py | Format-List Name, Length
      shell: pwsh
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 requests bs4 psutil python-dotenv curl-cffi
        pip install Cython setuptools
    
    - name: Create config.py with secrets
      run: |
        echo # config.py - Generated by GitHub Actions > config.py
        echo. >> config.py
        echo SECRET_KEY = b"${{ secrets.SECRET_KEY }}" >> config.py
        echo API_URL = "${{ secrets.API_URL }}" >> config.py
        echo API_URL_SITE = "${{ secrets.API_URL_SITE }}" >> config.py
        echo AUTH_CODE = "${{ secrets.AUTH_CODE }}" >> config.py
        echo OK config.py created
      shell: cmd
    
    - name: Compile modules to .pyd files
      run: |
        Write-Host "Compilando modulos para .pyd..."
        python setup.py build_ext --inplace
        
        # Verificar e renomear uxmod.pyd
        if (Test-Path -Path "uxmod.cp311-win_amd64.pyd") {
          Copy-Item "uxmod.cp311-win_amd64.pyd" "uxmod.pyd" -Force
          Write-Host "OK uxmod.pyd criado"
        } elseif (Test-Path -Path "uxmod*.pyd") {
          $pydFile = Get-ChildItem -Filter "uxmod*.pyd" | Select-Object -First 1
          Copy-Item $pydFile.Name "uxmod.pyd" -Force
          Write-Host "OK uxmod.pyd criado"
        } else {
          Write-Error "ERRO uxmod.pyd nao gerado"
          exit 1
        }
        
        # Verificar e renomear xcore.pyd
        if (Test-Path -Path "xcore.cp311-win_amd64.pyd") {
          Copy-Item "xcore.cp311-win_amd64.pyd" "xcore.pyd" -Force
          Write-Host "OK xcore.pyd criado"
        } elseif (Test-Path -Path "xcore*.pyd") {
          $pydFile = Get-ChildItem -Filter "xcore*.pyd" | Select-Object -First 1
          Copy-Item $pydFile.Name "xcore.pyd" -Force
          Write-Host "OK xcore.pyd criado"
        } else {
          Write-Error "ERRO xcore.pyd nao gerado"
          exit 1
        }
        
        # Verificar e renomear datax.pyd
        if (Test-Path -Path "datax.cp311-win_amd64.pyd") {
          Copy-Item "datax.cp311-win_amd64.pyd" "datax.pyd" -Force
          Write-Host "OK datax.pyd criado"
        } elseif (Test-Path -Path "datax*.pyd") {
          $pydFile = Get-ChildItem -Filter "datax*.pyd" | Select-Object -First 1
          Copy-Item $pydFile.Name "datax.pyd" -Force
          Write-Host "OK datax.pyd criado"
        } else {
          Write-Error "ERRO datax.pyd nao gerado"
          exit 1
        }
        
        Write-Host "Todos os .pyd criados com sucesso!"
        Get-ChildItem *.pyd | Format-List Name, Length
      shell: pwsh
    
    - name: Build EXE with PyInstaller
      run: |
        Write-Host "Construindo GamesStore.exe..."
        pyinstaller --noconfirm --onefile --windowed `
          --icon "assets/Images/icon.ico" `
          --add-data "config;config/" `
          --add-data "config.py;." `
          --add-data "version.py;." `
          --add-data "updater.py;." `
          --add-data "rc.py;." `
          --add-data "uxmod.pyd;." `
          --add-data "xcore.pyd;." `
          --add-data "datax.pyd;." `
          --hidden-import "bs4" `
          --hidden-import "PyQt5" `
          --hidden-import "PyQt5.QtCore" `
          --hidden-import "PyQt5.QtGui" `
          --hidden-import "PyQt5.QtWidgets" `
          --hidden-import "PyQt5.QtNetwork" `
          --hidden-import "shutil" `
          --hidden-import "psutil" `
          --hidden-import "dotenv" `
          --hidden-import "requests" `
          --hidden-import "pyperclip" `
          --hidden-import "curl_cffi" `
          --hidden-import "subprocess" `
          --hidden-import "ctypes" `
          --hidden-import "keyboard" `
          --hidden-import "winsound" `
          --hidden-import "urllib.parse" `
          --hidden-import "urllib.request" `
          --name "GamesStore" main.py
        
        if (-not (Test-Path "dist\GamesStore.exe")) {
          Write-Error "ERRO: GamesStore.exe nao foi criado"
          exit 1
        }
        
        Write-Host "OK GamesStore.exe criado com sucesso"
        Get-Item "dist\GamesStore.exe" | Format-List Name, Length
      shell: pwsh
    
    - name: Verify EXE was created
      run: |
        if (Test-Path -Path "dist\GamesStore.exe") {
          Write-Host "OK GamesStore.exe criado"
          Get-Item "dist\GamesStore.exe" | Format-List Name, Length
        } else {
          Write-Error "ERRO GamesStore.exe nao gerado"
          exit 1
        }
      shell: pwsh
    
    - name: Cleanup sensitive files
      run: |
        Remove-Item "config.py" -Force -ErrorAction SilentlyContinue
        Remove-Item "uxmod.py" -Force -ErrorAction SilentlyContinue
        Remove-Item "xcore.py" -Force -ErrorAction SilentlyContinue
        Remove-Item "datax.py" -Force -ErrorAction SilentlyContinue
        Remove-Item "uxmod.c" -Force -ErrorAction SilentlyContinue
        Remove-Item "xcore.c" -Force -ErrorAction SilentlyContinue
        Remove-Item "datax.c" -Force -ErrorAction SilentlyContinue
        Write-Host "OK Cleanup concluido"
      shell: pwsh
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/GamesStore.exe
        body: |
          ## GamesStore ${{ github.ref_name }}
          
          **Download:**
          Clique em "GamesStore.exe" abaixo para baixar.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.ref_name }}
        path: |
          uxmod.pyd
          xcore.pyd
          datax.pyd
          dist/GamesStore.exe
